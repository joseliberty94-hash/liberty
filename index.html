<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRM Liberty</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">

<style>
body {margin:0; font-family:'Poppins',sans-serif; display:flex; background:#f4f6f9;}
.sidebar {width:230px; background:#0f172a; color:white; height:100vh; padding:20px;}
.sidebar h2 {text-align:center; margin-bottom:30px;}
.sidebar a {display:block; padding:12px; color:white; text-decoration:none; border-radius:8px; margin-bottom:10px; cursor:pointer;}
.sidebar a:hover {background:#1e293b;}
.main {flex:1; padding:25px; height:100vh; overflow:hidden;}
.card {background:white; padding:20px; border-radius:14px; box-shadow:0 0 10px rgba(0,0,0,.1); margin-bottom:20px;}
table {width:100%; border-collapse:collapse;}
th, td {padding:10px; border-bottom:1px solid #ddd; text-align:center;}
th {background:#e5e7eb; position:sticky; top:0;}
tr:hover {background:#eef2ff; cursor:pointer;}
.botones-registro {display:flex; gap:10px; margin-bottom:15px;}
.modal {display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); justify-content:center; align-items:center; z-index:200;}
.modal-content {background:white; padding:25px; border-radius:12px; width:400px;}
.modal-close {position:absolute; top:10px; right:15px; cursor:pointer;}
.table-container {max-height:420px; overflow-y:auto;}
.filtros-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px;}
</style>
</head>

<body>

<div class="sidebar">
<h2>CRM Liberty</h2>
<a onclick="mostrarSeccion('crmComercial')">ðŸ“‹ CRM Comercial</a>
<a onclick="mostrarSeccion('libertyStats')">ðŸ“Š Liberty Statistics</a>
</div>

<div class="main">

<div id="crmComercial">

<div class="card">
<h2>CRM Comercial</h2>
<div class="botones-registro">
<button onclick="abrirModal('modalAcciones')">AcciÃ³n</button>
</div>
</div>

<div class="card">
<h2>Listado</h2>

<div class="filtros-grid">
<input type="date" id="filtroFecha">
<select id="filtroMes">
<option value="">Mes</option>
<option value="01">Enero</option>
<option value="02">Febrero</option>
<option value="03">Marzo</option>
<option value="04">Abril</option>
<option value="05">Mayo</option>
<option value="06">Junio</option>
<option value="07">Julio</option>
<option value="08">Agosto</option>
<option value="09">Septiembre</option>
<option value="10">Octubre</option>
<option value="11">Noviembre</option>
<option value="12">Diciembre</option>
</select>
<select id="filtroAgencia"></select>
<select id="filtroVendedor"></select>
<button onclick="aplicarFiltros()">Filtrar</button>
<button onclick="limpiarFiltros()">Limpiar</button>
</div>
</div>

<div class="table-container">
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Agencia</th>
<th>Vendedor</th>
<th>Tipo</th>
<th>ObservaciÃ³n</th>
</tr>
</thead>
<tbody id="tablaAcciones"></tbody>
</table>
</div>

</div>

<div id="libertyStats" style="display:none">
<div class="card">
<h2>Liberty Statistics</h2>
</div>
</div>

</div>

<!-- MODAL EDITAR -->
<div id="modalEditarAccion" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="cerrarModal('modalEditarAccion')">&times;</span>
<h2>Editar AcciÃ³n</h2>
<input type="date" id="editFecha">
<input id="editAgencia">
<input id="editVendedor">
<input id="editTipo">
<textarea id="editObs"></textarea>
<button onclick="guardarEdicion()">Guardar Cambios</button>
</div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzhpio0y8ZwHZppVJ6-lWB8FjrzJUhvBlFGFwncfVC6COIROBl3dQyLxG7QFP9zKDDjVQ/exec";

let accionesOriginal=[];
let accionSeleccionadaRow=null;

function mostrarSeccion(id){
document.querySelectorAll('#crmComercial,#libertyStats').forEach(s=>s.style.display='none');
document.getElementById(id).style.display='block';
}

function abrirModal(id){document.getElementById(id).style.display='flex';}
function cerrarModal(id){document.getElementById(id).style.display='none';}

function formatearFecha(f){
return new Date(f).toISOString().split("T")[0];
}

function cargarAcciones(){
fetch(WEB_APP_URL+"?hoja="+encodeURIComponent("Acciones comerciales"))
.then(r=>r.json())
.then(data=>{
accionesOriginal=data;
llenarFiltros();
mostrarAcciones(data);
});
}

function mostrarAcciones(lista){
const tbody=document.getElementById("tablaAcciones");
tbody.innerHTML="";
lista.forEach(a=>{
tbody.innerHTML+=`
<tr onclick="abrirEditarAccion(${a.row})">
<td>${formatearFecha(a.fecha)}</td>
<td>${a.agencia}</td>
<td>${a.vendedor}</td>
<td>${a.tipoAccion}</td>
<td>${a.observacion}</td>
</tr>`;
});
}

function abrirEditarAccion(row){
accionSeleccionadaRow=row;
const a=accionesOriginal.find(x=>x.row==row);

editFecha.value=formatearFecha(a.fecha);
editAgencia.value=a.agencia;
editVendedor.value=a.vendedor;
editTipo.value=a.tipoAccion;
editObs.value=a.observacion;

abrirModal("modalEditarAccion");
}

function guardarEdicion(){
fetch(WEB_APP_URL,{
method:"POST",
body:JSON.stringify({
tipo:"editarAccion",
row:accionSeleccionadaRow,
fecha:editFecha.value,
agencia:editAgencia.value,
vendedor:editVendedor.value,
tipoAccion:editTipo.value,
observacion:editObs.value
})
}).then(()=>{
alert("Actualizado");
cerrarModal("modalEditarAccion");
cargarAcciones();
});
}

function llenarFiltros(){
const agencias=[...new Set(accionesOriginal.map(a=>a.agencia))];
const vendedores=[...new Set(accionesOriginal.map(a=>a.vendedor))];
filtroAgencia.innerHTML='<option value="">Agencia</option>';
filtroVendedor.innerHTML='<option value="">Vendedor</option>';
agencias.forEach(a=>filtroAgencia.innerHTML+=`<option>${a}</option>`);
vendedores.forEach(v=>filtroVendedor.innerHTML+=`<option>${v}</option>`);
}

function aplicarFiltros(){
const fFecha=filtroFecha.value;
const fMes=filtroMes.value;
const fAg=filtroAgencia.value;
const fVe=filtroVendedor.value;

const res=accionesOriginal.filter(a=>{
let ok=true;
if(fFecha) ok &= formatearFecha(a.fecha)==fFecha;
if(fMes) ok &= formatearFecha(a.fecha).split("-")[1]==fMes;
if(fAg) ok &= a.agencia==fAg;
if(fVe) ok &= a.vendedor==fVe;
return ok;
});

mostrarAcciones(res);
}

function limpiarFiltros(){
filtroFecha.value="";
filtroMes.value="";
filtroAgencia.value="";
filtroVendedor.value="";
mostrarAcciones(accionesOriginal);
}

cargarAcciones();
</script>

</body>
</html>
