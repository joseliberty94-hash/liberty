<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CRM Liberty</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
body {margin:0; font-family:'Poppins',sans-serif; display:flex; background:#f4f6f9;}
.sidebar {width:230px; background:#0f172a; color:white; height:100vh; padding:20px;}
.sidebar h2 {text-align:center; margin-bottom:30px;}
.sidebar a {display:block; padding:12px; color:white; text-decoration:none; border-radius:8px; margin-bottom:10px; cursor:pointer;}
.sidebar a:hover {background:#1e293b;}
.main {flex:1; padding:25px; overflow-y:auto;}
.card {background:white; padding:20px; border-radius:14px; box-shadow:0 0 10px rgba(0,0,0,.1); margin-bottom:20px;}
h2 {margin-top:0;}
input, select, textarea, button {padding:10px; border-radius:8px; border:1px solid #ccc; margin:5px 0;}
button {background:#2563eb; color:white; border:none; cursor:pointer;}
button:hover {background:#1d4ed8;}
table {width:100%; border-collapse:collapse; margin-top:15px;}
th, td {padding:10px; border-bottom:1px solid #ddd; text-align:center;}
th {background:#e5e7eb;}
.botones-registro {display:flex; gap:10px; margin-bottom:15px;}
.botones-registro button {flex:1; font-size:14px; padding:8px;}
.modal {display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:100;}
.modal-content {background:white; padding:25px; border-radius:12px; width:400px; max-width:90%; position:relative;}
.modal-close {position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold; font-size:18px;}
.filtros {display:flex; gap:10px; flex-wrap:wrap;}
</style>
</head>
<body>

<div class="sidebar">
  <h2>CRM Liberty</h2>
  <a onclick="mostrarSeccion('crmComercial')"> CRM Comercial</a>
  <a onclick="mostrarSeccion('libertyStats')"> Liberty Statistics</a>
</div>

<div class="main">

<div id="crmComercial" class="seccion">

<div class="card">
<h2>CRM Comercial</h2>
<div class="botones-registro">
<button onclick="abrirModal('modalAgencias')">Agencia</button>
<button onclick="abrirModal('modalVendedores')">Vendedor</button>
<button onclick="abrirModal('modalAcciones')">Acci贸n</button>
</div>
</div>

<div class="card">
<h2>Listado de Acciones Comerciales</h2>

<div class="filtros">
<input type="date" id="filtroFecha">

<select id="filtroMes">
<option value="">Mes</option>
<option value="01">Enero</option>
<option value="02">Febrero</option>
<option value="03">Marzo</option>
<option value="04">Abril</option>
<option value="05">Mayo</option>
<option value="06">Junio</option>
<option value="07">Julio</option>
<option value="08">Agosto</option>
<option value="09">Septiembre</option>
<option value="10">Octubre</option>
<option value="11">Noviembre</option>
<option value="12">Diciembre</option>
</select>

<select id="filtroAgencia"><option value="">Agencia</option></select>
<select id="filtroVendedor"><option value="">Vendedor</option></select>

<button onclick="aplicarFiltros()">Filtrar</button>
<button onclick="limpiarFiltros()">Limpiar</button>
</div>

<table>
<thead>
<tr>
<th>Fecha</th><th>Agencia</th><th>Vendedor</th><th>Tipo</th><th>Observaci贸n</th>
</tr>
</thead>
<tbody id="tablaAcciones"></tbody>
</table>
</div>
</div>

<div id="libertyStats" class="seccion" style="display:none;">
<div class="card">
<h2>Liberty Statistics</h2>
<p>Pr贸ximamente gr谩ficos y KPIs</p>
</div>
</div>

</div>

<!-- MODALES -->
<div id="modalAgencias" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="cerrarModal('modalAgencias')">&times;</span>
<h2>Registrar Agencia</h2>
<input id="agNombre" placeholder="Nombre">
<input id="agMail" placeholder="Mail">
<input id="agTelefono" placeholder="Tel茅fono">
<button onclick="guardarAgencia()">Guardar</button>
</div>
</div>

<div id="modalVendedores" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="cerrarModal('modalVendedores')">&times;</span>
<h2>Registrar Vendedor</h2>
<input id="veNombre" placeholder="Nombre">
<input id="veMail" placeholder="Mail">
<select id="veEstado"><option>Activo</option><option>Inactivo</option></select>
<button onclick="guardarVendedor()">Guardar</button>
</div>
</div>

<div id="modalAcciones" class="modal">
<div class="modal-content">
<span class="modal-close" onclick="cerrarModal('modalAcciones')">&times;</span>
<h2>Registrar Acci贸n</h2>
<input type="date" id="acFecha">
<select id="acAgencia"></select>
<select id="acVendedor"></select>
<input id="acTipo" placeholder="Tipo Acci贸n">
<textarea id="acObs" placeholder="Observaci贸n"></textarea>
<button onclick="guardarAccion()">Guardar</button>
</div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzhpio0y8ZwHZppVJ6-lWB8FjrzJUhvBlFGFwncfVC6COIROBl3dQyLxG7QFP9zKDDjVQ/exec";

let acciones=[];
let accionesOriginal=[];

function mostrarSeccion(id){
document.querySelectorAll('.seccion').forEach(s=>s.style.display='none');
document.getElementById(id).style.display='block';
}

function abrirModal(id){document.getElementById(id).style.display='flex';}
function cerrarModal(id){document.getElementById(id).style.display='none';}

function formatearFecha(f){
const d=new Date(f);
return d.toISOString().split("T")[0];
}

function cargarAcciones(){
fetch(WEB_APP_URL+"?hoja="+encodeURIComponent("Acciones comerciales"))
.then(r=>r.json())
.then(data=>{
acciones=data.map(r=>({fecha:r[0],agencia:r[1],vendedor:r[2],tipoAccion:r[3],observacion:r[4]}));
accionesOriginal=[...acciones];
llenarFiltros();
mostrarAcciones(acciones);
});
}

function mostrarAcciones(lista){
const tbody=document.getElementById("tablaAcciones");
tbody.innerHTML="";
lista.forEach(a=>{
tbody.innerHTML+=`<tr>
<td>${formatearFecha(a.fecha)}</td>
<td>${a.agencia}</td>
<td>${a.vendedor}</td>
<td>${a.tipoAccion}</td>
<td>${a.observacion}</td>
</tr>`;
});
}

function llenarFiltros(){
const agencias=[...new Set(accionesOriginal.map(a=>a.agencia))];
const vendedores=[...new Set(accionesOriginal.map(a=>a.vendedor))];

const fa=document.getElementById("filtroAgencia");
const fv=document.getElementById("filtroVendedor");

fa.innerHTML='<option value="">Agencia</option>';
fv.innerHTML='<option value="">Vendedor</option>';

agencias.forEach(a=>fa.innerHTML+=`<option>${a}</option>`);
vendedores.forEach(v=>fv.innerHTML+=`<option>${v}</option>`);
}

function aplicarFiltros(){
const fFecha=filtroFecha.value;
const fMes=filtroMes.value;
const fAg=filtroAgencia.value;
const fVe=filtroVendedor.value;

const res=accionesOriginal.filter(a=>{
let ok=true;
if(fFecha) ok &= formatearFecha(a.fecha)==fFecha;
if(fMes) ok &= formatearFecha(a.fecha).split("-")[1]==fMes;
if(fAg) ok &= a.agencia==fAg;
if(fVe) ok &= a.vendedor==fVe;
return ok;
});

mostrarAcciones(res);
}

function limpiarFiltros(){
filtroFecha.value="";
filtroMes.value="";
filtroAgencia.value="";
filtroVendedor.value="";
mostrarAcciones(accionesOriginal);
}

function guardarAgencia(){
fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({tipo:"agencia",nombre:agNombre.value,mail:agMail.value,telefono:agTelefono.value})})
.then(()=>{alert("Agencia guardada");cerrarModal('modalAgencias');});
}

function guardarVendedor(){
fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({tipo:"vendedor",nombre:veNombre.value,mail:veMail.value,estado:veEstado.value})})
.then(()=>{alert("Vendedor guardado");cerrarModal('modalVendedores');});
}

function guardarAccion(){
fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({tipo:"accion",fecha:acFecha.value,agencia:acAgencia.value,vendedor:acVendedor.value,tipoAccion:acTipo.value,observacion:acObs.value})})
.then(()=>{alert("Acci贸n guardada");cerrarModal('modalAcciones');cargarAcciones();});
}

function cargarAgencias(){
fetch(WEB_APP_URL+"?hoja="+encodeURIComponent("Agencias"))
.then(r=>r.json()).then(d=>{
acAgencia.innerHTML="";
d.forEach(a=>acAgencia.innerHTML+=`<option>${a[0]}</option>`);
});
}

function cargarVendedores(){
fetch(WEB_APP_URL+"?hoja="+encodeURIComponent("Vendedores"))
.then(r=>r.json()).then(d=>{
acVendedor.innerHTML="";
d.forEach(v=>acVendedor.innerHTML+=`<option>${v[0]}</option>`);
});
}

cargarAgencias();
cargarVendedores();
cargarAcciones();
</script>
</body>
</html>
